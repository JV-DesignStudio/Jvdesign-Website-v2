<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stardust Collector | JVDesignStudio</title>
    <link rel="icon" type="image/png" href="https://placehold.co/32x32/1a202c/ffffff?text=JV">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- General Setup --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            /* Set base background for consistency */
            background-color: var(--color-light-beige);
        }
        
        /* --- Cozy Creatures Color Palette --- */
        :root {
            --color-light-beige: #F0EAD6; /* Creamy/Base */
            --color-soft-tan: #D2B48C;    /* Soft Tan */
            --color-muted-rose: #BC4749;  /* Muted Rose/Berry - Used for Primary Buttons */
            --color-cozy-teal: #70A3A7;   /* Muted Teal/Blue-Gray - Used for Links/Accents */
            --color-deep-charcoal: #403B33; /* Dark Contrast - Used for Text/Hover */
        }

        /* --- Full-Page Wave Animation (Cozy Background) --- */
        #wave-background {
            background: linear-gradient(
                -45deg,
                var(--color-light-beige) 0%,
                var(--color-soft-tan) 25%,
                var(--color-muted-rose) 50%,
                var(--color-cozy-teal) 75%,
                var(--color-light-beige) 100%
            );
            background-size: 400% 400%;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1; 
            animation: colorWave 45s ease-in-out infinite;
        }

        @keyframes colorWave {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Header Logo Color Shift (Harmonized with Cozy Colors) --- */
        @keyframes logo-color-shift {
            0% { color: var(--color-soft-tan); }
            33% { color: var(--color-muted-rose); }
            66% { color: var(--color-cozy-teal); }
            100% { color: var(--color-soft-tan); }
        }

        .logo-animated-name {
            display: inline-block;
            font-weight: 800;
            animation: logo-color-shift 6s infinite alternate ease-in-out;
        }

        /* --- Custom Styles: Updated to use Cozy Palette --- */
        /* Primary Button: Muted Rose */
        .btn-primary {
            background-color: var(--color-muted-rose); 
            transition: background-color 0.3s, transform 0.2s;
            color: white !important; /* Ensure white text */
        }
        .btn-primary:hover {
            background-color: var(--color-deep-charcoal); /* Dark charcoal hover */
            transform: translateY(-2px);
        }

        /* Navigation link using cozy teal with hover to deep charcoal */
        .nav-link {
            color: var(--color-cozy-teal);
            transition: color 0.15s ease-in-out;
        }
        .nav-link:hover {
            color: var(--color-deep-charcoal);
        }
        
        /* Card Hover Effect */
        .card-project {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-project:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* --- STARDUST GAME STYLES (RE-THEMED) --- */
        .game-font {
            font-family: 'Fredoka', cursive;
        }

        #game-area {
            position: relative;
            width: 95vw;
            max-width: 800px;
            height: 80vh;
            margin-top: 1rem;
            border-radius: 1rem;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.2); /* Softened shadow */
            /* Darker Inner Void (Unchanged - part of game) */
            background: radial-gradient(circle at center, #0e0036 0%, #00000a 100%);
            overflow: hidden;
            touch-action: none;
        }

        #player {
            position: absolute;
            width: 60px;
            height: 60px;
            z-index: 15;
            will-change: transform;
            border-radius: 50%;
            background-size: cover;
            background-image: url("https://placehold.co/60x60/a0f0ff/000?text=STAR");
            box-shadow: 0 0 15px rgba(160, 240, 255, 0.8);
            transition: filter 0.2s ease-in-out; /* For cosmic ray and damage effect */
        }

        .game-object {
            position: absolute;
            transition: opacity 0.3s ease-out, transform 0.3s ease-in;
            z-index: 10;
            background-size: cover;
            border-radius: 50%;
        }
        
        .collected {
            opacity: 0;
            transform: scale(0.1);
        }

        /* Scoreboard re-themed to match Cozy-Charcoal */
        #score-board {
            background-color: var(--color-deep-charcoal); /* MATCHES FOOTER */
            color: var(--color-light-beige); /* MATCHES FOOTER TEXT */
            text-shadow: 2px 2px 4px #000;
            border-radius: 0.5rem;
            max-width: 800px;
            width: 95vw;
        }

        #controls-info {
            font-size: 0.9rem;
            color: var(--color-deep-charcoal); /* Matched to body text */
            margin-top: 0.5rem;
            text-align: center;
        }

        /* Message box re-themed */
        #message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 1.5rem 3rem;
            background-color: var(--color-light-beige); /* MATCHES THEME */
            border-radius: 1rem;
            color: var(--color-deep-charcoal); /* MATCHES THEME */
            font-size: 2rem;
            font-weight: 700;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 20;
            display: none;
            text-align: center;
            border: 5px solid var(--color-cozy-teal); /* MATCHES THEME */
        }
        
        #message-box.game-over {
            background-color: #fff6f6; /* Light red */
            color: var(--color-muted-rose); /* Muted Rose */
            border-color: var(--color-muted-rose);
        }

        /* Restart button re-themed to match btn-primary */
        .restart-button {
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background-color: var(--color-muted-rose); /* MATCHES THEME */
            color: white;
            border-radius: 0.5rem;
            font-size: 1.25rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px #883a3b; /* Darker rose shadow */
        }

        .restart-button:hover {
            background-color: #A33B3D;
            transform: translateY(-1px);
            box-shadow: 0 5px #883a3b;
        }
        .restart-button:active {
            transform: translateY(3px);
            box-shadow: 0 1px #883a3b;
        }

        /* Responsive adjustments for mobile */
        @media (max-width: 640px) {
            #score-board {
                font-size: 1.2rem;
                padding: 0.75rem;
            }
            #player {
                width: 50px;
                height: 50px;
            }
            #message-box {
                font-size: 1.5rem;
                padding: 1rem 2rem;
            }
            #controls-info {
                font-size: 0.8rem;
            }
        }

        /* --- NEW STYLES: Dusts & Obstacles (6 Obstacles, 4 Dusts) --- */
        
        /* 4 Dusts (Stardust is the default 'game-object' look) */
        .moon-gem {
            background-image: url("https://placehold.co/50x50/3498db/000?text=GEM");
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.8);
        }
        .cosmic-crystal {
            background-image: url("https://placehold.co/40x40/00bfa5/000?text=üíé");
            box-shadow: 0 0 10px rgba(0, 191, 165, 0.9);
        }
        .nebula-diamond {
            background-image: url("https://placehold.co/35x35/8e24aa/fff?text=‚≠ê");
            box-shadow: 0 0 15px rgba(142, 36, 170, 1);
        }

        /* 6 Obstacles */
        .comet-storm {
            background-image: url("https://placehold.co/90x90/8b0000/fff?text=STORM");
            box-shadow: 0 0 20px rgba(139, 0, 0, 0.9);
        }
        .ice-asteroid {
            background-image: url("https://placehold.co/100x100/4fc3f7/000?text=ICE");
            box-shadow: 0 0 15px rgba(79, 195, 247, 0.9);
        }
        .volatile-fragment {
            background-image: url("https://placehold.co/30x30/ff5722/fff?text=V");
            box-shadow: 0 0 10px rgba(255, 87, 34, 0.9);
        }
        .gravitic-mine {
            background-image: url("https://placehold.co/80x80/263238/fff?text=MINE");
            box-shadow: 0 0 20px rgba(0, 0, 0, 1);
        }
        .cosmic-ray {
            background-image: url("https://placehold.co/50x50/ffeb3b/000?text=‚ö°");
            box-shadow: 0 0 20px rgba(255, 235, 59, 0.9);
        }
        .comet-obstacle { /* Default Shadow Comet */
             background-color: #cc3333; /* Red base */
        }
        
        /* Power-Up Base Style (5 Power-Ups) */
        .power-up {
            width: 50px;
            height: 50px;
            background-color: #2ecc71; /* Green base */
            border: 3px solid #f1c40f;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            text-shadow: 1px 1px 2px black;
            font-family: 'Inter', sans-serif;
            font-weight: bold;
        }

        /* Power-Up Specific Styles */
        .pu-shield { background-color: #3498db; }
        .pu-speed { background-color: #9b59b6; }
        .pu-magnet { background-color: #e67e22; }
        .pu-multiplier { background-color: #f1c40f; } /* Yellow */
        .pu-slow-motion { background-color: #1abc9c; } /* Teal */
    </style>
</head>
<body class="bg-light-beige">

    <div id="wave-background"></div>

    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex-shrink-0">
                    <a href="index.html" class="inline-flex items-center text-3xl" style="color: var(--color-deep-charcoal);">
                        <img src="logo.png" alt="JV Design Studio Logo" class="h-10 w-auto mr-2 rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/40x40/403B33/F0EAD6?text=JV'">
                        <span class="logo-animated-name">JVDesignStudio</span>
                    </a>
                </div>
                <nav class="flex items-center space-x-4">
                    <a href="content_hub.html" class="px-5 py-2 font-bold text-lg rounded-xl btn-primary shadow-md hover:shadow-lg">
                        üìö Content Hub
                    </a>
                    <a href="index.html#about" class="font-medium transition duration-150 hidden sm:block nav-link">
                        About
                    </a>
                </nav>
            </div>
        </div>
    </header>

    <main class="py-12 px-4 relative z-5">
        <div class="max-w-4xl mx-auto flex flex-col items-center justify-start">
            
            <h1 class="text-5xl sm:text-7xl font-extrabold text-gray-900 mb-6 leading-tight text-center game-font" style="color: var(--color-deep-charcoal);">
                Stardust <span style="color: var(--color-muted-rose);">Collector</span>
            </h1>
            
            <div id="score-board" class="flex justify-around items-center p-3 text-2xl font-bold game-font w-full">
                <span id="current-score-display">Collected Dust: 0</span>
                <span id="lives-display" class="text-3xl text-red-500">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
                <span class="text-xl font-bold text-yellow-300 hidden sm:inline mx-4">|</span>
                <span id="high-score-display" class="text-lg font-medium">Best Total: 0</span>
            </div>

            <div id="controls-info" class="game-font">
                Move: Use Arrow Keys / WASD or Drag on the screen. **Press SPACE/ENTER or Click to Start.**
            </div>

            <div id="game-area" class="mt-4 mb-8 w-full">
                <div id="player"></div>
                <div id="message-box" class="game-font">
                    </div>
            </div>

            <p class="text-sm max-w-xl text-center" style="color: var(--color-deep-charcoal);">
                Avoid the fiery Shadow Comets and collect as much shimmering Stardust as possible to fuel your space journey. Difficulty increases with your score!
            </p>

        </div>
    </main>

    <footer class="py-8 relative z-5" style="background-color: var(--color-deep-charcoal);">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-400">
            <p>&copy; 2025 JVDesignStudio. All rights reserved.</p>
        </div>
    </footer>
    
    <script>
        // --- GAME LOGIC (FIXES APPLIED) ---
        
        // --- IMAGE PLACEHOLDERS & CONSTANTS ---
        const PLAYER_IMAGE = "https://placehold.co/60x60/a0f0ff/000?text=STAR";

        // 4 Dusts
        const DUST_IMAGE = "https://placehold.co/40x40/ffe787/000?text=DUST"; 
        const GEM_IMAGE = "https://placehold.co/50x50/3498db/000?text=GEM"; 
        const CRYSTAL_IMAGE = "https://placehold.co/40x40/00bfa5/000?text=üíé"; 
        const DIAMOND_IMAGE = "https://placehold.co/35x35/8e24aa/fff?text=‚≠ê"; 

        // 6 Obstacles
        const SHADOW_COMET_IMAGE = "https://placehold.co/70x70/cc3333/fff?text=SHADOW";
        const STORM_COMET_IMAGE = "https://placehold.co/90x90/8b0000/fff?text=STORM";
        const ICE_ASTEROID_IMAGE = "https://placehold.co/100x100/4fc3f7/000?text=ICE";
        const VOLATILE_FRAGMENT_IMAGE = "https://placehold.co/30x30/ff5722/fff?text=V";
        const MINE_IMAGE = "https://placehold.co/80x80/263238/fff?text=MINE";
        const RAY_IMAGE = "https://placehold.co/50x50/ffeb3b/000?text=‚ö°"; // Cosmic Ray (Hazard)
        
        // --- GAME STATE & ELEMENTS ---
        const BASE_PLAYER_SPEED = 7; 
        let PLAYER_SPEED = BASE_PLAYER_SPEED; 
        const HIGH_SCORE_KEY = 'stardust_high_score';
        let SCROLL_SPEED = 3; 
        const POWER_UP_DURATION = 8000; // 8 seconds
        
        // LIVES STATE
        const MAX_LIVES = 3; 
        let currentLives = MAX_LIVES;
        let isInvincible = false;
        
        const player = document.getElementById('player');
        const gameArea = document.getElementById('game-area');
        const currentScoreDisplay = document.getElementById('current-score-display');
        const highScoreDisplay = document.getElementById('high-score-display');
        const messageBox = document.getElementById('message-box');
        const livesDisplay = document.getElementById('lives-display'); 

        let currentScore = 0;
        let highScore = 0;
        let scoreMultiplier = 1; 
        let gameActive = false;
        let gameLoopId = null;
        let objectSpawnTimer = 0;
        const BASE_SPAWN_INTERVAL = 60; // Frames per spawn
        let objects = []; 
        let audioContext = null;
        
        // 5 Power-Up State Management
        let powerUpState = {
            shield: { active: false, timer: null, element: player },
            speed: { active: false, timer: null },
            magnet: { active: false, timer: null, radius: 150 }, 
            multiplier: { active: false, timer: null, factor: 3 }, 
            slowMotion: { active: false, timer: null },
        };
        
        // Negative Power-Up State (Cosmic Ray)
        let playerSlowed = { active: false, timer: null };

        // Player position state
        let playerX = 0;
        let playerY = 0;
        const playerWidth = 60;
        const playerHeight = 60;

        // Movement state
        const keysPressed = {};
        let isTouching = false;


        // --- UTILITY FUNCTIONS (Audio) ---
        function getAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error("Web Audio API not supported or failed to initialize:", e);
                }
            }
            return audioContext;
        }

        function playCollectSound(pitch = 880) {
            const ctx = getAudioContext();
            if (!ctx) return;
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(pitch, ctx.currentTime);
            gainNode.gain.setValueAtTime(0.5, ctx.currentTime);
            oscillator.start();
            gainNode.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.15);
            oscillator.stop(ctx.currentTime + 0.15);
        }

        function playGameOverSound() {
            const ctx = getAudioContext();
            if (!ctx) return;
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(100, ctx.currentTime);
            gainNode.gain.setValueAtTime(0.8, ctx.currentTime);
            oscillator.start();
            gainNode.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);
            oscillator.stop(ctx.currentTime + 0.5);
        }

        // --- LOCAL STORAGE FUNCTIONS ---
        function loadHighScore() {
            try {
                const storedScore = localStorage.getItem(HIGH_SCORE_KEY);
                highScore = storedScore ? parseInt(storedScore, 10) : 0;
            } catch (e) {
                console.error("Error loading high score from localStorage:", e);
                highScore = 0;
            }
        }

        function saveScore() {
            if (currentScore > highScore) {
                try {
                    localStorage.setItem(HIGH_SCORE_KEY, currentScore.toString());
                    highScore = currentScore;
                    updateHighScoreDisplay();
                } catch (e) {
                    console.error("Error saving high score to localStorage:", e);
                }
            }
        }

        // --- VISUAL/STATE UPDATE HELPERS (NEWLY REFACTORED) ---
        
        // Only updates the player's transform (position)
        function updatePlayerVisualsPosition() {
            player.style.transform = `translate(${playerX}px, ${playerY}px)`;
        }

        /**
         * The core function to manage player speed and all visual effects 
         * (filter, image, box-shadow) based on all active power-ups and damage states.
         */
        function updatePlayerEffectVisuals() {
            // 1. Determine Speed
            if (playerSlowed.active) {
                PLAYER_SPEED = BASE_PLAYER_SPEED * 0.5;
            } else if (powerUpState.speed.active) {
                PLAYER_SPEED = BASE_PLAYER_SPEED * 1.5;
            } else {
                PLAYER_SPEED = BASE_PLAYER_SPEED;
            }

            // 2. Determine Filter and Image 
            if (isInvincible) {
                // If invincible, a temporary filter is applied directly in loseLife(), so we exit.
                return; 
            }

            // Set Filter
            player.style.filter = playerSlowed.active ? 'grayscale(100%)' : 'none';

            // Set Image (Speed overrides default)
            player.style.backgroundImage = `url(${powerUpState.speed.active ? "https://placehold.co/60x60/9b59b6/000?text=FAST" : PLAYER_IMAGE})`;

            // 3. Set Box Shadow (Shield/Magnet/Multiplier overrides default)
            let newBoxShadow = '0 0 15px rgba(160, 240, 255, 0.8)'; // Default
            if (powerUpState.shield.active) {
                newBoxShadow = '0 0 20px 5px #3498db'; // Blue glow
            } else if (powerUpState.magnet.active) {
                newBoxShadow = `0 0 10px 10px #e67e22`; // Orange glow
            } else if (powerUpState.multiplier.active) {
                newBoxShadow = `0 0 15px 5px #f1c40f`; // Yellow glow
            }
            player.style.boxShadow = newBoxShadow;
        }

        // --- LIVES AND DAMAGE LOGIC ---
        
        function updateLivesDisplay() {
            if (!livesDisplay) return; // Defensive check
            // Display filled hearts (‚ù§Ô∏è) for remaining lives and empty hearts (ü§ç) for lost lives
            livesDisplay.innerHTML = '‚ù§Ô∏è'.repeat(currentLives) + 'ü§ç'.repeat(MAX_LIVES - currentLives);
        }

        function loseLife() {
            if (isInvincible || !gameActive || currentLives <= 0) return;

            currentLives--;
            updateLivesDisplay();
            playCollectSound(300); // Low sound for damage taken

            if (currentLives <= 0) {
                gameOver();
            } else {
                // Apply a short invincibility period after taking damage
                isInvincible = true;
                player.style.filter = 'brightness(300%)'; // Flash effect - temporary override

                setTimeout(() => {
                    isInvincible = false;
                    // Call the effect visual function to reset the player to the correct post-invincibility state
                    updatePlayerEffectVisuals(); 
                }, 1500); // 1.5 seconds of invincibility
            }
        }

        // --- POWER-UP LOGIC ---

        // Handles the negative effect of the Cosmic Ray
        function deactivatePlayerSlow() {
            clearTimeout(playerSlowed.timer);
            playerSlowed.active = false;
            updatePlayerEffectVisuals(); // Reapply correct speed/visuals
        }

        // Function to apply a power-up effect
        function handlePowerUp(type) {
            
            if (type === 'cosmicRayHazard') {
                playCollectSound(200); 
                clearTimeout(playerSlowed.timer);
                playerSlowed.active = true;
                updatePlayerEffectVisuals(); // Apply slow speed/grayscale
                playerSlowed.timer = setTimeout(deactivatePlayerSlow, POWER_UP_DURATION * 0.75);
                return; 
            }
            
            // For all positive power-ups:
            clearTimeout(powerUpState[type]?.timer);
            playCollectSound(1200);

            switch(type) {
                case 'multiplier':
                    scoreMultiplier = powerUpState.multiplier.factor;
                    updateCurrentScoreDisplay();
                    break;
                case 'slowMotion':
                    gameArea.style.filter = 'grayscale(50%) brightness(80%)'; 
                    break;
            }
            // Set the state and update visuals
            if (powerUpState[type]) {
                powerUpState[type].active = true;
                updatePlayerEffectVisuals();

                // Set the timer to turn the power-up off
                powerUpState[type].timer = setTimeout(() => {
                    deactivatePowerUp(type);
                }, POWER_UP_DURATION);
            }
        }

        // Function to deactivate a positive power-up effect
        function deactivatePowerUp(type) {
            clearTimeout(powerUpState[type]?.timer);
            if (!powerUpState[type]) return; 
            powerUpState[type].active = false;
            
            // Revert specific power-up effects that need custom logic
            switch(type) {
                case 'multiplier':
                    scoreMultiplier = 1;
                    updateCurrentScoreDisplay(); 
                    break;
                case 'slowMotion':
                    gameArea.style.filter = 'none';
                    break;
            }
            // Update the combined visuals
            updatePlayerEffectVisuals();
        }

        // --- GAME LOGIC FUNCTIONS ---

        function initializeGame() {
            // Check if gameArea element is loaded and has a size greater than zero
            if (!gameArea || gameArea.clientWidth === 0) {
                 console.error("Game Area not loaded or dimensions are zero. Retrying initialization.");
                 // Fallback to a short timeout if window.onload failed to wait for dimensions
                 setTimeout(initializeGame, 100); 
                 return;
            }
            
            loadHighScore();
            const areaHeight = gameArea.clientHeight;
            const areaWidth = gameArea.clientWidth;

            // Initialize player position to 85% down and centered
            playerY = areaHeight * 0.85 - playerHeight / 2;
            playerX = areaWidth / 2 - playerWidth / 2;
            
            updatePlayerVisualsPosition();
            updateHighScoreDisplay();
            updateLivesDisplay(); 
            updatePlayerEffectVisuals(); // Set initial default effects

            messageBox.innerHTML = `
                Welcome to Stardust Collector!
                <button class="restart-button" onclick="window.startGame()">Start Journey</button>
            `;
            messageBox.style.display = 'block';

            if (!gameLoopId) {
                gameLoop();
            }
        }

        function startGame() {
            if (gameActive) return;
            
            currentScore = 0;
            scoreMultiplier = 1; 
            SCROLL_SPEED = 3; 
            currentLives = MAX_LIVES; // Reset lives
            isInvincible = false; // Reset invincibility
            gameActive = true;
            messageBox.style.display = 'none';
            messageBox.classList.remove('game-over');
            
            // Reset all power-up states
            Object.keys(powerUpState).forEach(type => deactivatePowerUp(type));
            deactivatePlayerSlow(); 

            objects.forEach(obj => obj.element.remove());
            objects = [];

            playerX = gameArea.clientWidth / 2 - playerWidth / 2;
            updatePlayerVisualsPosition();
            updateCurrentScoreDisplay();
            updateLivesDisplay();
            updatePlayerEffectVisuals(); // Reapply clean effects
        }

        function gameOver() {
            if (!gameActive) return;

            gameActive = false;
            playGameOverSound();
            
            saveScore(); 
            messageBox.classList.add('game-over');
            messageBox.innerHTML = `
                <span class="text-4xl">üåå Lost in the Nebula! üåå</span>
                <div class="text-xl font-normal mt-2">Collected Dust: ${currentScore}</div>
                ${currentScore > highScore ? '<div class="text-yellow-600 font-extrabold">NEW BEST!</div>' : ''}
                <div class="text-base font-normal">Best Total: ${highScore}</div>
                <button class="restart-button" onclick="window.startGame()">Start Again</button>
            `;
            messageBox.style.display = 'block';
        }

        function updateCurrentScoreDisplay() {
            currentScoreDisplay.textContent = `Collected Dust: ${currentScore} ${scoreMultiplier > 1 ? `(x${scoreMultiplier})` : ''}`;
        }

        function updateHighScoreDisplay() {
            highScoreDisplay.textContent = `Best Total: ${highScore}`;
        }

        // Creates a new falling object
        function spawnObject() {
            const spawnDefinitions = [
                // 4 Dusts
                { type: 'dust-particle', className: 'dust-particle', size: 40, image: DUST_IMAGE, scoreValue: 1, isCollectible: true, weight: 40, pitch: 880 }, 
                { type: 'moon-gem', className: 'moon-gem', size: 50, image: GEM_IMAGE, scoreValue: 5, isCollectible: true, weight: 15, pitch: 1000 }, 
                { type: 'cosmic-crystal', className: 'cosmic-crystal', size: 40, image: CRYSTAL_IMAGE, scoreValue: 10, isCollectible: true, weight: 5, pitch: 1100 }, 
                { type: 'nebula-diamond', className: 'nebula-diamond', size: 35, image: DIAMOND_IMAGE, scoreValue: 25, isCollectible: true, weight: 1, pitch: 1200 }, 

                // 6 Obstacles/Hazards
                { type: 'comet-obstacle', className: 'comet-obstacle', size: 70, image: SHADOW_COMET_IMAGE, isCollectible: false, speedFactor: 1.5, weight: 15 },
                { type: 'comet-storm', className: 'comet-storm', size: 90, image: STORM_COMET_IMAGE, isCollectible: false, speedFactor: 2.0, weight: 5 },
                { type: 'ice-asteroid', className: 'ice-asteroid', size: 100, image: ICE_ASTEROID_IMAGE, isCollectible: false, speedFactor: 0.7, weight: 4 },
                { type: 'volatile-fragment', className: 'volatile-fragment', size: 30, image: VOLATILE_FRAGMENT_IMAGE, isCollectible: false, speedFactor: 2.5, weight: 8 },
                { type: 'gravitic-mine', className: 'gravitic-mine', size: 80, image: MINE_IMAGE, isCollectible: false, speedFactor: 1.0, logic: 'mine', weight: 3 },
                { type: 'cosmic-ray', className: 'cosmic-ray', icon: '‚ö°', isCollectible: false, logic: 'hazard', speedFactor: 1.2, weight: 2 },

                // 5 Power-Ups
                { type: 'power-up-shield', className: 'pu-shield', icon: 'üõ°Ô∏è', logicType: 'shield', isPowerUp: true, size: 50, weight: 0.8 }, 
                { type: 'power-up-speed', className: 'pu-speed', icon: '‚ö°', logicType: 'speed', isPowerUp: true, size: 50, weight: 0.8 },
                { type: 'power-up-magnet', className: 'pu-magnet', icon: 'üß≤', logicType: 'magnet', isPowerUp: true, size: 50, weight: 0.8 },
                { type: 'power-up-multiplier', className: 'pu-multiplier', icon: '‚úñÔ∏è3', logicType: 'multiplier', isPowerUp: true, size: 50, weight: 0.8 }, 
                { type: 'power-up-slow', className: 'pu-slow-motion', icon: 'üêå', logicType: 'slowMotion', isPowerUp: true, size: 50, weight: 0.8 },
            ];

            const totalWeight = spawnDefinitions.reduce((sum, def) => sum + (def.weight || 0), 0);
            let rand = Math.random() * totalWeight;
            let selectedDef = null;

            for (const def of spawnDefinitions) {
                rand -= (def.weight || 0);
                if (rand < 0) {
                    selectedDef = def;
                    break;
                }
            }

            if (!selectedDef) return; 

            const objElement = document.createElement('div');
            objElement.className = `game-object ${selectedDef.className}`;
            
            if (selectedDef.image) {
                objElement.style.backgroundImage = `url(${selectedDef.image})`;
            } else if (selectedDef.icon) {
                objElement.classList.add('power-up');
                objElement.innerHTML = selectedDef.icon;
            }
            
            const size = selectedDef.size;
            const width = gameArea.clientWidth;
            const x = Math.random() * (width - size);
            const y = -size;

            objElement.style.width = `${size}px`;
            objElement.style.height = `${size}px`;
            objElement.style.left = `${x}px`;
            objElement.style.top = `${y}px`;

            const obj = {
                element: objElement,
                x: x,
                y: y,
                width: size,
                height: size,
                def: selectedDef, 
                isActivated: false, 
                id: crypto.randomUUID()
            };

            objects.push(obj);
            gameArea.appendChild(objElement);
        }

        // Moves all falling objects and checks for collisions
        function updateObjects() {
            const nextObjects = [];
            const isMagnetActive = powerUpState.magnet.active;
            const magnetRadius = powerUpState.magnet.radius;
            
            // 1. Base SCROLL_SPEED increases with score (Difficulty Ramp)
            let baseScroll = 3 + (currentScore * 0.005); 
            
            // Apply Slow Motion power-up effect
            if (powerUpState.slowMotion.active) {
                baseScroll *= 0.5; 
            }
            SCROLL_SPEED = baseScroll;

            // Player center coordinates (for magnet calculation)
            const pCX = playerX + playerWidth / 2;
            const pCY = playerY + playerHeight / 2;

            for (let i = 0; i < objects.length; i++) {
                const obj = objects[i];
                const def = obj.def;
                
                // --- A. Calculate Vertical Movement Speed ---
                let speedMultiplier = 1;
                let isObstacle = !def.isCollectible && !def.isPowerUp;

                if (isObstacle) { 
                    speedMultiplier = def.speedFactor;
                    speedMultiplier += (currentScore * 0.001); 

                    if (def.type === 'gravitic-mine') {
                        if (obj.y > gameArea.clientHeight * 0.25 && !obj.isActivated) {
                            obj.isActivated = true; 
                        }
                        speedMultiplier = obj.isActivated ? 3.0 : 0.1;
                    }
                }

                const verticalMovement = SCROLL_SPEED * speedMultiplier;

                // --- B. Apply Magnet Effect & Update X/Y Position for Magnet ---
                if (isMagnetActive && def.isCollectible && !obj.element.classList.contains('collected')) {
                    const oCX = obj.x + obj.width / 2;
                    const oCY = obj.y + obj.height / 2;
                    const distanceX = pCX - oCX;
                    const distanceY = pCY - oCY;
                    const distanceSquared = (distanceX * distanceX) + (distanceY * distanceY);
                    const distance = Math.sqrt(distanceSquared);
                    
                    if (distance > 1 && distance < magnetRadius) { 
                        const attractionForce = 0.05 * (magnetRadius - distance);
                        
                        const normalX = distanceX / distance;
                        const normalY = distanceY / distance;
                        
                        obj.x += normalX * attractionForce; 
                        obj.y += normalX * attractionForce; // Changed to normalX * attractionForce to make it move towards the player
                        
                        const maxWidth = gameArea.clientWidth - obj.width;
                        obj.x = Math.max(0, Math.min(obj.x, maxWidth));

                        obj.element.style.left = `${obj.x}px`;
                    }
                }
                
                // --- C. Apply Vertical Fall Movement & Update Y Position for Fall and Magnet ---
                obj.y += verticalMovement;
                obj.element.style.top = `${obj.y}px`;


                // --- D. Check if off screen (remove) ---
                if (obj.y > gameArea.clientHeight) {
                    obj.element.remove();
                    continue;
                }

                // --- E. Check Collision ---
                if (!obj.element.classList.contains('collected') && checkCollision(obj)) {
                    
                    if (def.isPowerUp) {
                        handlePowerUp(def.logicType);
                        obj.element.classList.add('collected');
                    } else if (def.isCollectible) {
                        obj.element.classList.add('collected');
                        playCollectSound(def.pitch); 
                        currentScore += (def.scoreValue * scoreMultiplier);
                        updateCurrentScoreDisplay();
                    } else if (isObstacle) {
                        
                        obj.element.classList.add('collected'); 
                        
                        if (def.type === 'cosmic-ray') {
                            handlePowerUp('cosmicRayHazard');
                            continue;
                        } else if (powerUpState.shield.active) {
                            deactivatePowerUp('shield');
                            continue; 
                        } else {
                            loseLife();
                            if (currentLives <= 0) return; 
                            continue;
                        }
                    }
                }

                nextObjects.push(obj);
            }

            objects = nextObjects;

            const currentSpawnInterval = Math.max(30, BASE_SPAWN_INTERVAL - Math.floor(currentScore / 2));
            objectSpawnTimer++;
            if (objectSpawnTimer >= currentSpawnInterval) {
                spawnObject();
                objectSpawnTimer = 0;
            }
        }

        // Simple circle collision check
        function checkCollision(obj) {
            const pCX = playerX + playerWidth / 2;
            const pCY = playerY + playerHeight / 2;
            const pR = playerWidth * 0.4; 

            const oCX = obj.x + obj.width / 2;
            const oCY = obj.y + obj.height / 2;
            const oR = obj.width * 0.4; 

            const distanceX = pCX - oCX;
            const distanceY = pCY - oCY;
            const distanceSquared = (distanceX * distanceX) + (distanceY * distanceY);
            const requiredDistance = pR + oR;

            return distanceSquared < requiredDistance * requiredDistance;
        }

        // --- MOVEMENT AND GAME LOOP ---

        function updatePlayerPosition() {
            let dx = 0;

            if (keysPressed['arrowleft'] || keysPressed['a']) dx -= 1;
            if (keysPressed['arrowright'] || keysPressed['d']) dx += 1;

            playerX += dx * PLAYER_SPEED;

            const maxWidth = gameArea.clientWidth - playerWidth;

            playerX = Math.max(0, Math.min(playerX, maxWidth));

            updatePlayerVisualsPosition();
        }

        function gameLoop() {
            if (gameActive) {
                updatePlayerPosition();
                updateObjects();
            }
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        // --- EVENT LISTENERS (Inputs) ---

        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            
            if (!gameActive && messageBox.style.display === 'block') {
                if (key === ' ' || key === 'enter') {
                    startGame();
                    e.preventDefault(); 
                    return;
                }
            }

            if (['arrowleft', 'arrowright', 'a', 'd'].includes(key)) {
                keysPressed[key] = true;
                e.preventDefault(); 
            }
        });

        document.addEventListener('keyup', (e) => {
            keysPressed[e.key.toLowerCase()] = false;
        });

        // Mouse Click Control for Starting the Game on PC/Tablet
        gameArea.addEventListener('click', (e) => {
            if (!gameActive && messageBox.style.display === 'block') {
                if (!e.target.classList.contains('restart-button')) {
                    startGame();
                }
            }
        });

        // Touch/Drag Control for Mobile
        gameArea.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                e.preventDefault();
                if (gameActive) {
                    isTouching = true;
                } else if (messageBox.style.display === 'block' && !e.target.classList.contains('restart-button')) {
                    startGame();
                }
            }
        }, { passive: false });

        gameArea.addEventListener('touchmove', (e) => {
            if (isTouching && e.touches.length === 1 && gameActive) {
                e.preventDefault();
                const touchX = e.touches[0].clientX;
                const gameRect = gameArea.getBoundingClientRect();

                const newX = touchX - gameRect.left - playerWidth / 2;
                const maxWidth = gameArea.clientWidth - playerWidth;

                playerX = Math.max(0, Math.min(newX, maxWidth));

                updatePlayerVisualsPosition();
            }
        }, { passive: false });

        gameArea.addEventListener('touchend', () => {
            isTouching = false;
        });
        
        window.startGame = startGame;

        // --- START GAME ---
        // Using window.onload ensures that ALL external resources and CSS dimensions are calculated
        window.onload = initializeGame;

    </script>
</body>
</html>